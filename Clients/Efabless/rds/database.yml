---
AWSTemplateFormatVersion: 2010-09-09
Description: >-
  RDS Database template, this template allows the creation
  of a fresh RDS database or restore it from a snapshot. It uses
  Secrets Manager to manage the credentials

Parameters:

  Identifier:
    Type: String
    Description: A name identifier for the RDS instance

  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC to host the RDS instance

  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Subnet Ids to host the RDS instance

  SourceSecurityGroup:
    Type: AWS::EC2::SecurityGroup::Id
    Description: Security Group Id to allow traffic from

  DBName:
    Type: String
    Description: The name of the default database in the instance
  
  DBUsername:
    Type: String
    Description: Master username for the RDS database

  DBClass:
    Type: String
    Default: db.t2.small
    Description: Database instance class
    AllowedValues: [ db.t2.micro, db.t2.small, db.t2.medium, db.t2.large, db.t3.micro, db.t3.small, db.t3.medium, db.t3.large, db.m1.small, db.m1.large, db.m1.xlarge, db.m2.xlarge, db.m4.large, db.m4.xlarge, db.m4.2xlarge, db.m4.4xlarge, db.m4.10xlarge, db.m3.medium, db.m3.large, db.m3.xlarge, db.m3.2xlarge, db.r3.large, db.r3.xlarge, db.r3.2xlarge, db.r3.4xlarge, db.r3.8xlarge ]

  DBAllocatedStorage:
    Type: Number
    Default: 50
    Description: The amount of storage (in GB) to allocate to the DB Instance

  DBStorageClass:
    Type: String    
    Description: The database storage class to use
    Default: gp2
    AllowedValues:
    - gp2
    - standard
  
  DBStorageEncrypted:
    Type: String
    Default: false
    Description: Specifies whether the DB instance is encrypted
    AllowedValues:
    - true
    - false

  DBFamily:
    Type: String
    Description: The database engine family for the ParameterGroup

  DBEngine:
    Type: String
    Description: The database engine for the RDS

  DBEngineVersion:
    Type: String
    Description: The database engine version

  DBPort:
    Type: Number
    Description: The port number for the Database engine

  DBSnapshotIdentifier:
    Type: String
    Default: ''
    Description: Optional - The RDS snapshot to restore the DB instance

  PreferredBackupWindow:
    Description: Enter Preferred Backup Window Time (UTC).
    Type: String
    Default: 17:00-19:00

  PreferredMaintenanceWindow:
    Description: Enter Preferred Maintenance Window Time (UTC).
    Type: String
    Default: Sun:19:00-Sun:23:00

  BackupRetentionPeriod:
    Type: Number
    Default: 5
    Description: Number of days to keep the database backup

  OwnerName:
    Type: String
    Default: efabless
    Description: An arbitrary tag name for the owner of these resources

  StackName:
    Type: String
    Description: The name of the stack to which these resources belong

  Environment:
    Type: String
    Default: dev
    AllowedValues: [ prod, staging, dev, qa ]
    Description: Environment name to append to resources names and tags

Conditions:

  RestoreFromSnapshot: !Not [ !Equals [ !Ref DBSnapshotIdentifier, '' ] ]

Resources:

  # ########## Security Groups #########

  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref VpcId
      GroupName: !Sub ${Identifier}-${Environment}-rds-sg
      GroupDescription: Allow connections to the database port only from the soruce security group
      SecurityGroupIngress:
      - { IpProtocol: 6, SourceSecurityGroupId: !Ref SourceSecurityGroup, FromPort: !Ref DBPort, ToPort: !Ref DBPort }
      SecurityGroupEgress:
      - { IpProtocol: -1, CidrIp: "0.0.0.0/0" }
      Tags:
      - Key: Name
        Value: !Sub ${Identifier}-${Environment}-rds-sg
      - Key: Owner
        Value: !Ref OwnerName
      - Key: StackName
        Value: !Ref StackName
      - Key: Environment
        Value: !Ref Environment
  # ############# Database #############
  ParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties: 
      Description: Parameter Group for ${Identifier}-${Environment} - ${DBFamily} 
      Family: !Ref DBFamily
      Parameters: !Ref AWS::NoValue
      
  SubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      SubnetIds: !Ref SubnetIds
      DBSubnetGroupName: !Sub ${Identifier}-${Environment}-subnetgroup
      DBSubnetGroupDescription: !Sub Subnets available for ${Identifier}-${Environment} RDS

  DBCredentialsSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub /databases/${Environment}/${Identifier}
      Description: !Sub Credentials secret for ${Identifier}-${Environment} database
      GenerateSecretString:
        SecretStringTemplate: !Sub '{"username": "${DBUsername}"}'
        GenerateStringKey: password
        PasswordLength: 16
        ExcludeCharacters: '\"@/\\'
  
  SecretAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId: !Ref DBCredentialsSecret
      TargetId: !Ref DBInstance
      TargetType: AWS::RDS::DBInstance


  DBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub ${Identifier}-${Environment}-rds
      DBName: !If [ RestoreFromSnapshot, !Ref 'AWS::NoValue', !Ref DBName ]
      MasterUsername: !If [ RestoreFromSnapshot, !Ref 'AWS::NoValue', !Sub '{{resolve:secretsmanager:${DBCredentialsSecret}:SecretString:username}}' ]
      MasterUserPassword: !If [ RestoreFromSnapshot, !Ref 'AWS::NoValue', !Sub '{{resolve:secretsmanager:${DBCredentialsSecret}:SecretString:password}}' ]
      Engine: !Ref DBEngine
      EngineVersion: !Ref DBEngineVersion
      DBInstanceClass: !Ref DBClass
      AllocatedStorage: !Ref DBAllocatedStorage
      StorageType: !Ref DBStorageClass
      StorageEncrypted: !Ref DBStorageEncrypted
      DBParameterGroupName: !Ref ParameterGroup
      DBSubnetGroupName: !Ref SubnetGroup
      VPCSecurityGroups:
      - !Ref SecurityGroup
      DBSnapshotIdentifier: !If [ RestoreFromSnapshot, !Ref DBSnapshotIdentifier, !Ref 'AWS::NoValue' ]
      MultiAZ: true
      PubliclyAccessible: false
      DeletionProtection: true
      BackupRetentionPeriod: !Ref BackupRetentionPeriod
      PreferredBackupWindow: !Ref PreferredBackupWindow
      PreferredMaintenanceWindow: !Ref PreferredMaintenanceWindow
      CopyTagsToSnapshot: true
      Tags:
      - Key: Name
        Value: !Sub ${Identifier}-${Environment}-rds
      - Key: Owner
        Value: !Ref OwnerName
      - Key: StackName
        Value: !Ref StackName
      - Key: Environment
        Value: !Ref Environment

Outputs:

  DBEndpoint:
    Description: Primary endpoint address
    Value: !GetAtt DBInstance.Endpoint.Address

  DBPort:
    Description: Database endpoint port number
    Value: !GetAtt DBInstance.Endpoint.Port

  DBSecurityGroupId:
    Description: Database security group
    Value: !Ref SecurityGroup

  DBName:
    Description: Default database name
    Value: !Ref DBName

  CredentialsSecret:
    Description: The database credentials secret
    Value: !Ref DBCredentialsSecret
