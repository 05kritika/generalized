AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Resources to create a Load Balancer that exposes the application running
Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC to host the Load Balancer
  SubnetsIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Subnet Ids to host the Load Balancer
  CertificateArn:
    Type: String
    Default: ""
    Description: SSL Certificate ARN
  S3BucketLogs:
    Type: String
    Description: S3 bucket to store the load balancer access logs
  StackName:
    Type: String
    Default: demo
    Description: This will be used to name the resources
  Environment:
    Type: String
    Default: Dev
    AllowedValues: [Prod, Stage, Dev]
Conditions:
  SslCertificateArnPresent: !Not [!Equals [!Ref CertificateArn, ""]]
Resources:
  ######### Security Groups #########
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref VpcId
      GroupDescription: Only allow HTTP and HTTPS comunication to the load balancer
      SecurityGroupIngress:
        - { IpProtocol: 6, CidrIp: "0.0.0.0/0", FromPort: 80, ToPort: 80 }
        - { IpProtocol: 6, CidrIp: "0.0.0.0/0", FromPort: 8080, ToPort: 8080 }
        - { IpProtocol: 6, CidrIp: "0.0.0.0/0", FromPort: 443, ToPort: 443 }
      SecurityGroupEgress:
        - { IpProtocol: -1, CidrIp: "0.0.0.0/0" }
      Tags:
        - Key: Environment
          Value: !Sub ${StackName}-${Environment}
  ########## Load Balancer ##########
  LoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Scheme: internet-facing
      Type: application
      Subnets: !Ref SubnetsIds
      LoadBalancerAttributes:
        - Key: access_logs.s3.enabled
          Value: true
        - Key: access_logs.s3.bucket
          Value: !Ref S3BucketLogs
      SecurityGroups:
        - !Ref SecurityGroup
      Tags:
        - Key: Environment
          Value: !Sub ${StackName}-${Environment}
  BlueHttpListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref LoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref DefaultTargetGroup
  GreenHttpListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref LoadBalancer
      Port: 8080
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref DefaultTargetGroup
  # Conditioned if SSL Certificate is passed
  HttpsListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: SslCertificateArnPresent
    Properties:
      LoadBalancerArn: !Ref LoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref CertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref DefaultTargetGroup
  DefaultTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      VpcId: !Ref VpcId
      Port: 80
      Protocol: HTTP
      Tags:
        - Key: Name
          Value: DefaultTargetGroup
        - Key: Environment
          Value: !Sub ${StackName}-${Environment}

Outputs:
  CanonicalHostedZoneID:
    Description: Canonical Hosted Zone ID
    Value: !GetAtt LoadBalancer.CanonicalHostedZoneID
  BlueHttpListenerArn:
    Description: HTTP Listener ARN
    Value: !Ref BlueHttpListener
  GreenHttpListenerArn:
    Description: HTTP Listener ARN
    Value: !Ref GreenHttpListener
  # Conditioned if SSL Certificate is passed
  HttpsListenerArn:
    Description: HTTPS Listener ARN
    Value: !Ref HttpsListener
    Condition: SslCertificateArnPresent
  LoadBalancerArn:
    Description: Load Balancer ARN
    Value: !Ref LoadBalancer
  LoadBalancerDomain:
    Description: Load Balancer Domain
    Value: !GetAtt LoadBalancer.DNSName
  LoadBalancerName:
    Description: Load Balancer Name
    Value: !GetAtt LoadBalancer.LoadBalancerName
  SecurityGroupId:
    Description: Load Balancer Security Group ID
    Value: !Ref SecurityGroup